---
import Layout from "../../layouts/Layout.astro";
import PortfolioTemplate from "../../components/portfolio/PortfolioTemplate";
import { supabase } from "../../lib/supabase";

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/404");
}

import type { Profile } from "../../types/database";

// Fetch from Supabase
let artist = null;
let works: { id: string; url: string; title: string }[] = [];

const { data: profileData, error } = await supabase
    .from("profiles")
    .select("*")
    .eq("username", slug)
    .single();

if (error) {
    console.error("Error fetching artist profile:", error);
}

const profile = profileData as Profile;

if (profile) {
    artist = {
        name: profile.full_name || "Unknown Artist",
        role: profile.role || "Artist",
        avatar_url: profile.avatar_url || "https://via.placeholder.com/150",
        bio: profile.bio || "No bio available.",
        email: profile.email,
        instagram: profile.instagram, // Assuming these fields exist or handle gracefully
        website: profile.website,
    };

    // Fetch specific works from flash_tattoos table
    const { data: flash } = await supabase
        .from("flash_tattoos")
        .select("*")
        .eq("artist_id", profile.id)
        .eq("is_available", true)
        .order("created_at", { ascending: false })
        .limit(12);

    if (flash && flash.length > 0) {
        works = flash.map((f: any) => ({
            id: f.id,
            url: f.image_url,
            title: f.title,
        }));
    }
}

if (!artist) {
    return Astro.redirect("/404");
}
---

<Layout title={`${artist.name} | Portfolio`}>
    <main>
        <PortfolioTemplate client:only="react" artist={artist} works={works} />
    </main>
</Layout>
