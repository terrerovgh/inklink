---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Sign In - InkLink">
    <main class="flex min-h-screen items-center justify-center p-4">
        <div
            class="w-full max-w-md space-y-8 rounded-2xl border border-border bg-card p-10 shadow-xl"
        >
            <div class="text-center">
                <h1
                    class="font-outfit text-4xl font-bold tracking-tight text-primary"
                >
                    InkLink
                </h1>
                <h2 class="mt-4 text-xl font-medium text-muted-foreground">
                    Sign in to your account
                </h2>
            </div>

            <form class="space-y-6" id="signin-form">
                <div>
                    <label
                        for="email"
                        class="block text-sm font-medium text-foreground"
                        >Email address</label
                    >
                    <input
                        id="email"
                        name="email"
                        type="email"
                        autocomplete="email"
                        required
                        class="mt-2 block w-full rounded-md border border-input bg-background px-3 py-2 text-foreground shadow-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring sm:text-sm"
                    />
                </div>

                <div>
                    <label
                        for="password"
                        class="block text-sm font-medium text-foreground"
                        >Password</label
                    >
                    <input
                        id="password"
                        name="password"
                        type="password"
                        autocomplete="current-password"
                        required
                        class="mt-2 block w-full rounded-md border border-input bg-background px-3 py-2 text-foreground shadow-sm focus:border-ring focus:outline-none focus:ring-1 focus:ring-ring sm:text-sm"
                    />
                </div>

                <div class="flex items-center justify-between">
                    <div class="text-sm">
                        <a
                            href="#"
                            class="font-medium text-primary hover:text-primary/80"
                            >Forgot your password?</a
                        >
                    </div>
                </div>

                <div>
                    <button
                        type="submit"
                        class="flex w-full justify-center rounded-md border border-transparent bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow-sm hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
                    >
                        Sign in
                    </button>
                </div>
            </form>

            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-border"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="bg-card px-2 text-muted-foreground"
                        >Or continue with</span
                    >
                </div>
            </div>

            <div class="grid grid-cols-1 gap-3">
                <button
                    id="google-auth"
                    class="inline-flex w-full justify-center rounded-md border border-border bg-card px-4 py-2 text-sm font-medium text-foreground shadow-sm hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
                >
                    <span class="sr-only">Sign in with Google</span>
                    Google
                </button>
            </div>

            <p class="text-center text-sm text-muted-foreground">
                Not a member?
                <a
                    href="/auth/register"
                    class="font-medium text-primary hover:text-primary/80"
                    >Register now</a
                >
            </p>
        </div>
    </main>
</Layout>

<script>
    import { supabase } from "../../lib/supabase";

    const form = document.getElementById("signin-form") as HTMLFormElement;
    const googleBtn = document.getElementById("google-auth");

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const email = formData.get("email") as string;
        const password = formData.get("password") as string;

        const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password,
        });

        if (error) {
            alert(error.message);
        } else if (data.session) {
            // Set session cookies for the server (Astro Middleware)
            const expirationDate = new Date();
            expirationDate.setFullYear(expirationDate.getFullYear() + 1);
            const expires = expirationDate.toUTCString();

            document.cookie = `sb-access-token=${data.session.access_token}; Path=/; Expires=${expires}; SameSite=Lax;`;
            document.cookie = `sb-refresh-token=${data.session.refresh_token}; Path=/; Expires=${expires}; SameSite=Lax;`;

            window.location.href = "/dashboard";
        }
    });

    googleBtn?.addEventListener("click", async () => {
        const { error } = await supabase.auth.signInWithOAuth({
            provider: "google",
            options: {
                redirectTo: window.location.origin + "/dashboard",
            },
        });
        if (error) alert(error.message);
    });
</script>
