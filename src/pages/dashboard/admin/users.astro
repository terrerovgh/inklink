---
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import UserTable from "../../../components/admin/UserTable";
import { supabase } from "../../../lib/supabase";

// Security Check
const { user } = Astro.locals;
if (!user) return Astro.redirect("/auth/login");
const { data: profile } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", user.id)
    .single();
if ((profile as any)?.role?.toLowerCase() !== "admin")
    return Astro.redirect("/dashboard");

// Fetch Users (Limit 50 for now, real app needs pagination)
// We need to disable RLS or assume Admin has policy to view all.
// Assuming Admin policy exists or current RLS "Public profiles viewable by everyone" allows this.
const { data: users } = await supabase
    .from("profiles")
    .select("*")
    .order("created_at", { ascending: false })
    .limit(50);
---

<DashboardLayout title="User Management">
    <div class="space-y-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">Users</h1>
                <p class="text-muted-foreground">
                    Manage user roles and access.
                </p>
            </div>
            {
                /* <input type="text" placeholder="Search users..." class="px-4 py-2 border rounded-lg bg-background" /> */
            }
        </div>

        <UserTable client:load initialUsers={(users as any) || []} />
    </div>
</DashboardLayout>
