---
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import BookingTable from "../../../components/admin/BookingTable";
import { supabase } from "../../../lib/supabase";

// Security Check
const { user } = Astro.locals;
if (!user) return Astro.redirect("/auth/login");
const { data: profile } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", user.id)
    .single();
if ((profile as any)?.role?.toLowerCase() !== "admin")
    return Astro.redirect("/dashboard");

// Fetch Bookings with relations
const { data: bookings } = await supabase
    .from("bookings")
    .select(
        "*, client:client_id(full_name), artist:artist_id(full_name), dossier:dossier_id(title)",
    )
    .order("created_at", { ascending: false })
    .limit(50); // Limit for performance
---

<DashboardLayout title="Booking Management">
    <div class="space-y-6">
        <div>
            <h1 class="text-3xl font-bold tracking-tight">Bookings</h1>
            <p class="text-muted-foreground">
                Manage all platform inquiries and bookings.
            </p>
        </div>

        <BookingTable client:load initialBookings={(bookings as any) || []} />
    </div>
</DashboardLayout>
